name: Auto Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'core/**/*.py'
      - 'CHANGELOG.md'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate project structure
        run: |
          if [ ! -f "main.py" ]; then
            echo "错误: main.py 文件不存在"
            exit 1
          fi
          if [ ! -f "requirements.txt" ]; then
            echo "错误: requirements.txt 文件不存在"
            exit 1
          fi
          if [ ! -d "core" ]; then
            echo "错误: core 目录不存在"
            exit 1
          fi
          echo "项目结构验证通过"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get current version
        id: get_version
        run: |
          # 从main.py中提取版本号
          if [ -f "main.py" ]; then
            PY_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
            echo "PY_VERSION=${PY_VERSION}" >> $GITHUB_OUTPUT
            echo "当前版本: ${PY_VERSION}"
          else
            echo "错误: main.py文件不存在"
            exit 1
          fi

      - name: Check if version changed
        id: check_version
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          TAG_NAME="v${VERSION}"
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "版本 $VERSION 的发布已存在，将跳过创建"
            echo "SHOULD_CREATE=false" >> $GITHUB_OUTPUT
          else
            echo "版本 $VERSION 是新版本，将创建发布"
            echo "SHOULD_CREATE=true" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate release name
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        id: generate_release_info
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          TAG_NAME="v${VERSION}"
          echo "RELEASE_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "发布标签: ${TAG_NAME}"
          
          RELEASE_TITLE="Release v${VERSION}"
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes from CHANGELOG
        id: generate_changelog
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          if [ -f "CHANGELOG.md" ]; then
            awk -v version="$VERSION" '
              BEGIN { in_section=0; found=0 }
              index($0, "## [" version "]") == 1 { in_section=1; found=1; print; next }
              /^## \[/ && in_section { in_section=0 }
              in_section { print }
            ' CHANGELOG.md > release_notes.md
            
            if [ -s "release_notes.md" ]; then
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              cat release_notes.md >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              COMMIT_MSG="${{ github.event.head_commit.message }}"
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_release_info.outputs.RELEASE_NAME }}
          name: ${{ steps.generate_release_info.outputs.RELEASE_TITLE }}
          body: "${{ steps.generate_changelog.outputs.notes }}"
          draft: false
          prerelease: false
          generate_release_notes: false
      
      - name: Create release assets
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          RELEASE_DIR="sakura-channel-summary-assistant-${RELEASE_NAME}"
          
          mkdir -p "$RELEASE_DIR"
          
          # 复制核心代码
          if [ -f "main.py" ]; then cp main.py "$RELEASE_DIR/"; fi
          find core -name "*.py" -exec cp --parents {} "$RELEASE_DIR/" \;
          rm -rf "$RELEASE_DIR/core/__pycache__"
          
          # 创建 data 目录
          mkdir -p "$RELEASE_DIR/data"
          
          # 复制配置文件及其他必要资源
          [ -f "data/.env.example" ] && cp "data/.env.example" "$RELEASE_DIR/data/"
          [ -f "data/config.example.json" ] && cp "data/config.example.json" "$RELEASE_DIR/data/"
          [ -f "requirements.txt" ] && cp requirements.txt "$RELEASE_DIR/"
          [ -f "README.md" ] && cp README.md "$RELEASE_DIR/"
          [ -f "README_EN.md" ] && cp README_EN.md "$RELEASE_DIR/"
          [ -f "CHANGELOG.md" ] && cp CHANGELOG.md "$RELEASE_DIR/"
          [ -f "LICENSE" ] && cp LICENSE "$RELEASE_DIR/"
          
          # 脚本及 Docker
          for f in start.bat start.sh Dockerfile docker-compose.yml docker-entrypoint.sh; do
            [ -f "$f" ] && cp "$f" "$RELEASE_DIR/"
          done
          
          # 提示词
          [ -f "data/prompt.txt" ] && cp "data/prompt.txt" "$RELEASE_DIR/data/"
          [ -f "data/poll_prompt.txt" ] && cp "data/poll_prompt.txt" "$RELEASE_DIR/data/"
          
          chmod +x "$RELEASE_DIR/start.sh" 2>/dev/null || true
          chmod +x "$RELEASE_DIR/docker-entrypoint.sh" 2>/dev/null || true
          
          tar -czf "${RELEASE_DIR}.tar.gz" "$RELEASE_DIR/"
          zip -r "${RELEASE_DIR}.zip" "$RELEASE_DIR/"

      - name: Upload release assets
        if: steps.check_version.outputs.SHOULD_CREATE == 'true'
        run: |
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          ASSET_NAME="sakura-channel-summary-assistant-${RELEASE_NAME}"
          gh release upload "$RELEASE_NAME" "${ASSET_NAME}.tar.gz" "${ASSET_NAME}.zip" --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          rm -f release_notes.md
          rm -rf "sakura-channel-summary-assistant-v${{ steps.get_version.outputs.PY_VERSION }}"
          rm -f sakura-channel-summary-assistant-v${{ steps.get_version.outputs.PY_VERSION }}.*