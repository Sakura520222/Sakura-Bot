name: Auto Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'CHANGELOG.md'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get current version
        id: get_version
        run: |
          # 从main.py中提取版本号
          if [ -f "main.py" ]; then
            PY_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
            echo "PY_VERSION=${PY_VERSION}" >> $GITHUB_OUTPUT
            echo "当前版本: ${PY_VERSION}"
          else
            echo "错误: main.py文件不存在"
            exit 1
          fi
      
      - name: Generate release name
        id: generate_release_info
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          COMMIT_HASH=$(git rev-parse --short HEAD)
          COMMIT_DATE=$(date +'%Y-%m-%d')
          
          # 生成唯一的发布名称
          RELEASE_NAME="v${VERSION}-${COMMIT_HASH}"
          echo "RELEASE_NAME=${RELEASE_NAME}" >> $GITHUB_OUTPUT
          echo "发布名称: ${RELEASE_NAME}"
          
          # 生成发布标题
          RELEASE_TITLE="Sakura频道总结助手 v${VERSION} (${COMMIT_DATE})"
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes from CHANGELOG
        id: generate_changelog
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          # 从CHANGELOG.md中提取当前版本的更新日志
          if [ -f "CHANGELOG.md" ]; then
            # 查找CHANGELOG.md中对应版本的部分
            awk -v version="$VERSION" '
              BEGIN { in_section=0; found=0 }
              /^## \['version'\]/ { in_section=1; found=1; print; next }
              /^## \[/ && in_section { in_section=0 }
              in_section { print }
            ' CHANGELOG.md > release_notes.md
            
            if [ -s "release_notes.md" ]; then
              echo "从CHANGELOG.md成功提取版本 $VERSION 的更新日志"
              # 将内容转换为单行，用于GitHub输出
              NOTES=$(cat release_notes.md | sed ':a;N;$!ba;s/\n/\\n/g')
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "$NOTES" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "警告: 在CHANGELOG.md中未找到版本 $VERSION 的更新日志"
              COMMIT_MSG="${{ github.event.head_commit.message }}"
              echo "notes=## [$VERSION] - $(date +'%Y-%m-%d')\\n\\n基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
            fi
          else
            echo "警告: CHANGELOG.md文件不存在"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "notes=## [$VERSION] - $(date +'%Y-%m-%d')\\n\\n基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_release_info.outputs.RELEASE_NAME }}
          name: ${{ steps.generate_release_info.outputs.RELEASE_TITLE }}
          body: "${{ steps.generate_changelog.outputs.notes }}"
          draft: false
          prerelease: false
          generate_release_notes: false
          files: |
            README.md
            CHANGELOG.md
            requirements.txt
            docker-compose.yml
            Dockerfile
            *.py
      
      - name: Create release assets
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          RELEASE_DIR="sakura-channel-summary-assistant-${RELEASE_NAME}"
          
          echo "创建发布资源包: 版本=$VERSION, 发布名称=$RELEASE_NAME"
          mkdir -p "$RELEASE_DIR"
          
          # 复制主要文件
          cp -r *.py *.txt *.md *.yml Dockerfile docker-entrypoint.sh "$RELEASE_DIR/" 2>/dev/null || true
          
          # 创建压缩包
          tar -czf "sakura-channel-summary-assistant-${RELEASE_NAME}.tar.gz" "$RELEASE_DIR/"
          zip -r "sakura-channel-summary-assistant-${RELEASE_NAME}.zip" "$RELEASE_DIR/"
          
          echo "发布资源包创建完成"
      
      - name: Upload release assets
        run: |
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          echo "上传发布资源到: $RELEASE_NAME"
          
          # 上传到release
          gh release upload "$RELEASE_NAME" \
            "sakura-channel-summary-assistant-${RELEASE_NAME}.tar.gz" \
            "sakura-channel-summary-assistant-${RELEASE_NAME}.zip" \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run basic tests
        run: |
          # 运行简单的导入测试
          python -c "import config; import main; print('导入测试通过')"
          python -c "from config import logger; logger.info('配置模块测试通过')"
          echo "基本测试完成"

  # 发送通知
  notify:
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    
    steps:
      - name: Send release status
        run: |
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "✅ 发布成功!"
            echo "发布名称: ${{ needs.create-release.outputs.RELEASE_NAME }}"
            echo "发布标题: ${{ needs.create-release.outputs.RELEASE_TITLE }}"
            echo "发布地址: https://github.com/${{ github.repository }}/releases/tag/${{ needs.create-release.outputs.RELEASE_NAME }}"
          else
            echo "❌ 发布失败"
            echo "请检查工作流日志了解详细错误信息"
          fi
