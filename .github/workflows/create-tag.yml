name: Auto Create Release

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'CHANGELOG.md'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get current version
        id: get_version
        run: |
          # 从main.py中提取版本号
          if [ -f "main.py" ]; then
            PY_VERSION=$(grep -o "__version__ = \"[^\"]*\"" main.py | cut -d'"' -f2)
            echo "PY_VERSION=${PY_VERSION}" >> $GITHUB_OUTPUT
            echo "当前版本: ${PY_VERSION}"
          else
            echo "错误: main.py文件不存在"
            exit 1
          fi
      
      - name: Generate release name
        id: generate_release_info
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          # 检查标签是否已存在
          TAG_NAME="v${VERSION}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "标签 $TAG_NAME 已存在，将更新现有发行版"
            TAG_EXISTS=true
          else
            echo "标签 $TAG_NAME 不存在，将创建新标签"
            TAG_EXISTS=false
          fi
          
          # 使用标准标签名称
          echo "RELEASE_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "TAG_EXISTS=${TAG_EXISTS}" >> $GITHUB_OUTPUT
          echo "发布标签: ${TAG_NAME}"
          
          # 生成标准发布标题
          RELEASE_TITLE="Release v${VERSION}"
          echo "RELEASE_TITLE=${RELEASE_TITLE}" >> $GITHUB_OUTPUT
      
      - name: Generate release notes from CHANGELOG
        id: generate_changelog
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          
          # 从CHANGELOG.md中提取当前版本的更新日志
          if [ -f "CHANGELOG.md" ]; then
            # 查找CHANGELOG.md中对应版本的部分
            awk -v version="$VERSION" '
              BEGIN { in_section=0; found=0 }
              index($0, "## [" version "]") == 1 { in_section=1; found=1; print; next }
              /^## \[/ && in_section { in_section=0 }
              in_section { print }
            ' CHANGELOG.md > release_notes.md
            
            if [ -s "release_notes.md" ]; then
              echo "从CHANGELOG.md成功提取版本 $VERSION 的更新日志"
              # 直接输出多行内容
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              cat release_notes.md >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "警告: 在CHANGELOG.md中未找到版本 $VERSION 的更新日志"
              COMMIT_MSG="${{ github.event.head_commit.message }}"
              echo "notes<<EOF" >> $GITHUB_OUTPUT
              echo "## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
              echo "" >> $GITHUB_OUTPUT
              echo "基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            fi
          else
            echo "警告: CHANGELOG.md文件不存在"
            COMMIT_MSG="${{ github.event.head_commit.message }}"
            echo "notes<<EOF" >> $GITHUB_OUTPUT
            echo "## [$VERSION] - $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "基于提交: $COMMIT_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.generate_release_info.outputs.RELEASE_NAME }}
          name: ${{ steps.generate_release_info.outputs.RELEASE_TITLE }}
          body: "${{ steps.generate_changelog.outputs.notes }}"
          draft: false
          prerelease: false
          generate_release_notes: false
          # 不再上传单个文件，只通过后续步骤上传压缩包
      
      - name: Create release assets
        run: |
          VERSION="${{ steps.get_version.outputs.PY_VERSION }}"
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          RELEASE_DIR="sakura-channel-summary-assistant-${RELEASE_NAME}"
          
          echo "创建发布资源包: 版本=$VERSION, 发布名称=$RELEASE_NAME"
          mkdir -p "$RELEASE_DIR"
          
          # 复制 Python 源文件（15个）
          for py_file in ai_client.py command_handlers.py config.py database.py error_handler.py \
                         history_handlers.py main.py poll_prompt_manager.py \
                         poll_regeneration_handlers.py prompt_manager.py scheduler.py \
                         summary_time_manager.py telegram_client.py telegram_client_utils.py; do
            if [ -f "$py_file" ]; then
              cp "$py_file" "$RELEASE_DIR/"
            fi
          done
          
          # 复制辅助工具（2个）
          for tool_file in restart_bot.py restart_bot_improved.py; do
            if [ -f "$tool_file" ]; then
              cp "$tool_file" "$RELEASE_DIR/"
            fi
          done
          
          # 复制配置文件
          for config_file in config.example.json .env.example requirements.txt; do
            if [ -f "$config_file" ]; then
              cp "$config_file" "$RELEASE_DIR/"
            fi
          done
          
          # 复制文档文件（仅用户需要的）
          for doc_file in README.md CHANGELOG.md LICENSE; do
            if [ -f "$doc_file" ]; then
              cp "$doc_file" "$RELEASE_DIR/"
            fi
          done
          
          # 复制启动脚本
          for script_file in start.bat start.sh; do
            if [ -f "$script_file" ]; then
              cp "$script_file" "$RELEASE_DIR/"
            fi
          done
          
          # 复制 Docker 相关文件
          for docker_file in Dockerfile docker-compose.yml docker-entrypoint.sh; do
            if [ -f "$docker_file" ]; then
              cp "$docker_file" "$RELEASE_DIR/"
            fi
          done
          
          # 复制提示词文件
          for prompt_file in prompt.txt poll_prompt.txt; do
            if [ -f "$prompt_file" ]; then
              cp "$prompt_file" "$RELEASE_DIR/"
            fi
          done
          
          # 设置可执行权限
          chmod +x "$RELEASE_DIR/start.sh"
          chmod +x "$RELEASE_DIR/docker-entrypoint.sh"
          echo "已设置可执行文件权限"
          
          # 创建压缩包
          tar -czf "sakura-channel-summary-assistant-${RELEASE_NAME}.tar.gz" "$RELEASE_DIR/"
          zip -r "sakura-channel-summary-assistant-${RELEASE_NAME}.zip" "$RELEASE_DIR/"
          
          echo "发布资源包创建完成，包含所有必要文件"
      
      - name: Upload release assets
        run: |
          RELEASE_NAME="${{ steps.generate_release_info.outputs.RELEASE_NAME }}"
          echo "上传发布资源到: $RELEASE_NAME"
          
          # 上传到release
          gh release upload "$RELEASE_NAME" \
            "sakura-channel-summary-assistant-${RELEASE_NAME}.tar.gz" \
            "sakura-channel-summary-assistant-${RELEASE_NAME}.zip" \
            --clobber
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
