{% extends "base.html" %}

{% block title %}仪表板{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-card:hover .stat-icon {
    transform: scale(1.1) rotate(5deg);
}

.stat-icon {
    transition: all 0.3s ease;
}

.chart-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

@media (max-width: 768px) {
    .chart-row {
        grid-template-columns: 1fr;
    }
}

.quick-action-btn {
    height: 100%;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.quick-action-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

.quick-action-btn:hover .action-icon {
    transform: scale(1.1);
}

.action-icon {
    transition: all 0.3s ease;
    font-size: 1.75rem;
}

.realtime-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    background-color: var(--bs-body-bg);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    z-index: 1000;
    border: 1px solid var(--bs-border-color);
}

.realtime-indicator .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--success-color);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.5;
        transform: scale(1.2);
    }
}

.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 2rem;
    font-weight: 500;
}

.status-badge::before {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
}
</style>
{% endblock %}

{% block content %}
<!-- 页面标题 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-1">
                    <i class="bi bi-speedometer2 me-2 text-primary"></i>仪表板
                </h1>
                <p class="text-muted mb-0">系统概览和实时监控</p>
            </div>
            <div>
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="bi bi-arrow-clockwise me-1"></i>刷新数据
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 统计卡片 -->
<div class="stats-grid">
    <div class="card stat-card bg-primary text-white h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-title text-white-50">频道数量</h6>
                    <h2 class="mb-0 fw-bold">{{ channels_count }}</h2>
                    <small class="text-white-50">
                        <i class="bi bi-collection-play"></i> 监控中
                    </small>
                </div>
                <div class="stat-icon text-white-50">
                    <i class="bi bi-collection-play" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card stat-card bg-success text-white h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-title text-white-50">系统健康</h6>
                    <h4 class="mb-0 fw-bold">
                        {% if health_status == "healthy" %}
                            <span class="status-badge bg-light text-success">
                                <i class="bi bi-check-circle-fill me-1"></i>健康
                            </span>
                        {% elif health_status == "warning" %}
                            <span class="status-badge bg-light text-warning">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>警告
                            </span>
                        {% else %}
                            <span class="status-badge bg-light text-danger">
                                <i class="bi bi-x-circle-fill me-1"></i>异常
                            </span>
                        {% endif %}
                    </h4>
                </div>
                <div class="stat-icon text-white-50">
                    <i class="bi bi-heart-pulse" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card stat-card bg-info text-white h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-title text-white-50">AI模型</h6>
                    <h5 class="mb-0 fw-bold">{{ ai_model }}</h5>
                    <small class="text-white-50 text-truncate d-block" style="max-width: 200px;">
                        {{ ai_base_url }}
                    </small>
                </div>
                <div class="stat-icon text-white-50">
                    <i class="bi bi-cpu" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card stat-card bg-warning text-dark h-100">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="card-title text-dark opacity-50">管理员数量</h6>
                    <h2 class="mb-0 fw-bold">{{ admin_count }}</h2>
                    <small class="text-dark opacity-50">
                        <i class="bi bi-people"></i> 已授权
                    </small>
                </div>
                <div class="stat-icon text-dark opacity-50">
                    <i class="bi bi-people" style="font-size: 3rem;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 机器人状态控制 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-robot me-2"></i>机器人状态控制
                </h5>
                <span class="badge bg-primary" id="lastUpdate">刚刚更新</span>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4 mb-3 mb-md-0">
                        <div id="bot-status-card" class="text-center p-4 bg-body-secondary rounded">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mb-0">正在获取机器人状态...</p>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div id="bot-control-buttons" class="d-flex flex-wrap gap-2">
                            <button class="btn btn-outline-primary" onclick="refreshBotStatus()">
                                <i class="bi bi-arrow-clockwise me-1"></i>刷新状态
                            </button>
                            <button class="btn btn-outline-warning" onclick="pauseBot()" id="pause-btn" disabled>
                                <i class="bi bi-pause-circle me-1"></i>暂停机器人
                            </button>
                            <button class="btn btn-outline-success" onclick="resumeBot()" id="resume-btn" disabled>
                                <i class="bi bi-play-circle me-1"></i>恢复机器人
                            </button>
                            <button class="btn btn-outline-danger" onclick="shutdownBot()" id="shutdown-btn" disabled>
                                <i class="bi bi-power me-1"></i>关机机器人
                            </button>
                            <button class="btn btn-outline-secondary" onclick="restartBot()">
                                <i class="bi bi-arrow-clockwise me-1"></i>重启机器人
                            </button>
                        </div>
                        <div class="mt-3">
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <strong>状态说明：</strong>
                                运行中 - 机器人正常运行；已暂停 - 定时任务已停止；关机中 - 机器人正在关闭
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="chart-row">
    <!-- 总结趋势图 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-graph-up me-2"></i>总结趋势（最近7天）
            </h5>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    时间范围
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateSummaryChart('7d')">最近7天</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateSummaryChart('30d')">最近30天</a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateSummaryChart('90d')">最近90天</a></li>
                </ul>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="summaryTrendChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 错误统计图 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-exclamation-triangle me-2"></i>错误统计
            </h5>
            <button class="btn btn-sm btn-outline-danger" onclick="clearErrorStats()">
                <i class="bi bi-trash me-1"></i>清空
            </button>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="errorStatsChart"></canvas>
            </div>
            {% if error_stats %}
            <div class="row mt-3 text-center">
                <div class="col">
                    <div class="stat-box">
                        <div class="stat-value text-danger">{{ error_stats.get('error_count', 0) }}</div>
                        <div class="stat-label">总错误数</div>
                    </div>
                </div>
                <div class="col">
                    <div class="stat-box">
                        <div class="stat-value text-warning">{{ error_stats.get('warning_count', 0) }}</div>
                        <div class="stat-label">警告数</div>
                    </div>
                </div>
                <div class="col">
                    <div class="stat-box">
                        <div class="stat-value text-info">{{ error_stats.get('last_24h_errors', 0) }}</div>
                        <div class="stat-label">24小时内</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 频道列表和快速操作 -->
<div class="chart-row">
    <!-- 频道总结时间表 -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>频道总结时间表
            </h5>
            <span class="badge bg-info">{{ summary_schedules|length }} 个定时任务</span>
        </div>
        <div class="card-body p-0">
            {% if summary_schedules %}
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>频道</th>
                            <th>星期</th>
                            <th>时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for channel, schedule in summary_schedules.items() %}
                        <tr>
                            <td>
                                <code class="text-truncate d-block" style="max-width: 150px;">
                                    {{ channel[:30] }}{% if channel|length > 30 %}...{% endif %}
                                </code>
                            </td>
                            <td>
                                {% set day_map = {'mon': '周一', 'tue': '周二', 'wed': '周三', 'thu': '周四', 'fri': '周五', 'sat': '周六', 'sun': '周日'} %}
                                <span class="badge bg-info">{{ day_map.get(schedule.day, schedule.day) }}</span>
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ "%02d:%02d"|format(schedule.hour, schedule.minute) }}</span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="triggerChannelSummary('{{ channel }}')">
                                    <i class="bi bi-play-fill"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-calendar-x text-muted" style="font-size: 3rem;"></i>
                <h5 class="mt-3 text-muted">暂无定时任务</h5>
                <p class="text-muted">在频道管理页面添加定时任务</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 快速操作 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="bi bi-lightning me-2"></i>快速操作
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-6 col-md-4">
                    <a href="/channels" class="btn btn-outline-primary quick-action-btn">
                        <i class="bi bi-plus-circle action-icon"></i>
                        <span>添加频道</span>
                    </a>
                </div>
                <div class="col-6 col-md-4">
                    <a href="/config" class="btn btn-outline-success quick-action-btn">
                        <i class="bi bi-pencil action-icon"></i>
                        <span>修改配置</span>
                    </a>
                </div>
                <div class="col-6 col-md-4">
                    <a href="/tasks" class="btn btn-outline-info quick-action-btn">
                        <i class="bi bi-play-circle action-icon"></i>
                        <span>手动总结</span>
                    </a>
                </div>
                <div class="col-6 col-md-4">
                    <a href="/logs" class="btn btn-outline-secondary quick-action-btn">
                        <i class="bi bi-journal-text action-icon"></i>
                        <span>查看日志</span>
                    </a>
                </div>
                <div class="col-6 col-md-4">
                    <button class="btn btn-outline-warning quick-action-btn" onclick="runHealthCheck()">
                        <i class="bi bi-heart-pulse action-icon"></i>
                        <span>健康检查</span>
                    </button>
                </div>
                <div class="col-6 col-md-4">
                    <button class="btn btn-outline-danger quick-action-btn" onclick="restartBot()">
                        <i class="bi bi-arrow-clockwise action-icon"></i>
                        <span>重启机器人</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 最近活动 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-activity me-2"></i>最近活动
                </h5>
                <a href="/tasks" class="btn btn-sm btn-outline-primary">
                    查看全部 <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
            <div class="card-body">
                <div class="timeline" id="recentActivityTimeline">
                    <!-- 动态加载最近活动 -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">加载最近活动...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 实时指示器 -->
<div class="realtime-indicator">
    <div class="dot"></div>
    <small class="text-muted">实时监控中</small>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 图表实例
let summaryTrendChart = null;
let errorStatsChart = null;

// 错误统计数据
const errorStatsData = {{ error_stats|tojson if error_stats else '{}' }};

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('仪表板页面初始化...');
    
    // 加载仪表板专用JavaScript
    const script = document.createElement('script');
    script.src = '/static/js/dashboard.js';
    script.onload = function() {
        console.log('仪表板JS加载完成');
    };
    script.onerror = function() {
        console.error('仪表板JS加载失败');
    };
    document.head.appendChild(script);
});
</script>
{% endblock %}
